<template>
  <v-container>
    <v-row justify="center" style="margin-top: 2%;">
      <h1>new election</h1>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center mt-10">
      <v-col cols="2">
        <p class="text-h6">name:</p>
      </v-col>
      <v-col cols="5">
        <v-text-field hide-details="auto" v-model="name" placeholder="name" />
      </v-col>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center mt-10">
      <v-col cols="2">
        <p class="text-h6">start:</p>
      </v-col>
      <v-col cols="5">
        <v-text-field hide-details="auto" v-model="start" placeholder="start" />
      </v-col>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center mt-10">
      <v-col cols="2">
        <p class="text-h6">end:</p>
      </v-col>
      <v-col cols="5">
        <v-text-field hide-details="auto" v-model="end" placeholder="end" />
      </v-col>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center mt-10">
      <v-col cols="2">
        <p class="text-h6">count:</p>
      </v-col>
      <v-col cols="5">
        <v-text-field hide-details="auto" v-model="count" placeholder="end" />
      </v-col>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center mt-10">
      <v-col cols="2">
        <p class="text-h6">candidates:</p>
      </v-col>
      <v-col cols="5">
        <v-text-field hide-details="auto" v-model="candidates" placeholder="candidates" />
      </v-col>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center mt-10">
      <v-col cols="2">
        <p class="text-h6">description:</p>
      </v-col>
      <v-col cols="5">
        <v-textarea label="description" v-model="description"></v-textarea>
      </v-col>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center">
      <v-col cols="2">
        <v-btn @click="deployContract()" block>create</v-btn>
      </v-col>
    </v-row>
    <v-row justify="center" class="text-center d-flex align-center">
      <v-col cols="2">
        <v-btn block class="text-subtitle-1" @click="() => { router.push('/admin') }">
          <p>Back</p>
        </v-btn>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup>
import { useRouter } from 'vue-router'
import { ethers } from 'ethers'
import { ref } from 'vue'
import axios from 'axios';

const router = useRouter()
const name = ref('')
const start = ref('')
const end = ref('')
const count = ref('')
const candidates = ref('')
const description = ref('')

const registerContractAddress = '0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9'
let provider
let signer
const abi = [
    {
      "inputs": [
        {
          "internalType": "string[]",
          "name": "_candidateNames",
          "type": "string[]"
        },
        {
          "internalType": "uint256",
          "name": "_startTime",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_endTime",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_votingCount",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_voteName",
          "type": "string"
        },
        {
          "internalType": "address",
          "name": "_userRegistryAddress",
          "type": "address"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "voter",
          "type": "address"
        }
      ],
      "name": "VoteCast",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "candidates",
      "outputs": [
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "voteCount",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getAllVotesOfCandiates",
      "outputs": [
        {
          "components": [
            {
              "internalType": "string",
              "name": "name",
              "type": "string"
            },
            {
              "internalType": "uint256",
              "name": "voteCount",
              "type": "uint256"
            }
          ],
          "internalType": "struct Voting.Candidate[]",
          "name": "",
          "type": "tuple[]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getBlockTimestamp",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getRemainingTime",
      "outputs": [
        {
          "internalType": "uint256[4]",
          "name": "",
          "type": "uint256[4]"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getVoteName",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getVotingStatus",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "newFunc",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "pure",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_candidateIndex",
          "type": "uint256"
        }
      ],
      "name": "vote",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "voters",
      "outputs": [
        {
          "internalType": "bool",
          "name": "",
          "type": "bool"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "votingCount",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "votingCreate",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "votingEnd",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "votingName",
      "outputs": [
        {
          "internalType": "string",
          "name": "",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "votingStart",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ]
const bytecode =
  '0x60806040523480156200001157600080fd5b5060405162001b6138038062001b618339818101604052810190620000379190620004c8565b33600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550846003819055508360048190555042600581905550826006819055508160079081620000a59190620007e3565b5080600860006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060005b86518110156200018c5760006040518060400160405280898481518110620001175762000116620008ca565b5b60200260200101518152602001600081525090806001815401808255809150506001900390600052602060002090600202016000909190919091506000820151816000019081620001699190620007e3565b506020820151816001015550508080620001839062000928565b915050620000ea565b5050505050505062000975565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620001fd82620001b2565b810181811067ffffffffffffffff821117156200021f576200021e620001c3565b5b80604052505050565b60006200023462000199565b9050620002428282620001f2565b919050565b600067ffffffffffffffff821115620002655762000264620001c3565b5b602082029050602081019050919050565b600080fd5b600080fd5b600067ffffffffffffffff8211156200029e576200029d620001c3565b5b620002a982620001b2565b9050602081019050919050565b60005b83811015620002d6578082015181840152602081019050620002b9565b60008484015250505050565b6000620002f9620002f38462000280565b62000228565b9050828152602081018484840111156200031857620003176200027b565b5b62000325848285620002b6565b509392505050565b600082601f830112620003455762000344620001ad565b5b815162000357848260208601620002e2565b91505092915050565b600062000377620003718462000247565b62000228565b905080838252602082019050602084028301858111156200039d576200039c62000276565b5b835b81811015620003eb57805167ffffffffffffffff811115620003c657620003c5620001ad565b5b808601620003d589826200032d565b855260208501945050506020810190506200039f565b5050509392505050565b600082601f8301126200040d576200040c620001ad565b5b81516200041f84826020860162000360565b91505092915050565b6000819050919050565b6200043d8162000428565b81146200044957600080fd5b50565b6000815190506200045d8162000432565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620004908262000463565b9050919050565b620004a28162000483565b8114620004ae57600080fd5b50565b600081519050620004c28162000497565b92915050565b60008060008060008060c08789031215620004e857620004e7620001a3565b5b600087015167ffffffffffffffff811115620005095762000508620001a8565b5b6200051789828a01620003f5565b96505060206200052a89828a016200044c565b95505060406200053d89828a016200044c565b94505060606200055089828a016200044c565b935050608087015167ffffffffffffffff811115620005745762000573620001a8565b5b6200058289828a016200032d565b92505060a06200059589828a01620004b1565b9150509295509295509295565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620005f557607f821691505b6020821081036200060b576200060a620005ad565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620006757fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8262000636565b62000681868362000636565b95508019841693508086168417925050509392505050565b6000819050919050565b6000620006c4620006be620006b88462000428565b62000699565b62000428565b9050919050565b6000819050919050565b620006e083620006a3565b620006f8620006ef82620006cb565b84845462000643565b825550505050565b600090565b6200070f62000700565b6200071c818484620006d5565b505050565b5b8181101562000744576200073860008262000705565b60018101905062000722565b5050565b601f82111562000793576200075d8162000611565b620007688462000626565b8101602085101562000778578190505b62000790620007878562000626565b83018262000721565b50505b505050565b600082821c905092915050565b6000620007b86000198460080262000798565b1980831691505092915050565b6000620007d38383620007a5565b9150826002028217905092915050565b620007ee82620005a2565b67ffffffffffffffff8111156200080a5762000809620001c3565b5b620008168254620005dc565b6200082382828562000748565b600060209050601f8311600181146200085b576000841562000846578287015190505b620008528582620007c5565b865550620008c2565b601f1984166200086b8662000611565b60005b8281101562000895578489015182556001820191506020850194506020810190506200086e565b86831015620008b55784890151620008b1601f891682620007a5565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000620009358262000428565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036200096a5762000969620008f9565b5b600182019050919050565b6111dc80620009856000396000f3fe608060405234801561001057600080fd5b50600436106100ea5760003560e01c8063796b89b91161008c578063b424ab8411610066578063b424ab841461023e578063e9bd438a1461025c578063efb98bcf1461027a578063f61ceba414610298576100ea565b8063796b89b9146101d257806385a38635146101f0578063a3ec138d1461020e576100ea565b80633477ee2e116100c85780633477ee2e146101475780634d6bda5f14610178578063572bedd514610196578063581c281c146101b4576100ea565b80630121b93f146100ef578063101158af1461010b57806310c1671e14610129575b600080fd5b610109600480360381019061010491906109d6565b6102b6565b005b6101136105d5565b6040516101209190610a12565b60405180910390f35b6101316105db565b60405161013e9190610a12565b60405180910390f35b610161600480360381019061015c91906109d6565b6105e1565b60405161016f929190610abd565b60405180910390f35b61018061069d565b60405161018d9190610c45565b60405180910390f35b61019e610798565b6040516101ab9190610c67565b60405180910390f35b6101bc6107d5565b6040516101c99190610ca4565b60405180910390f35b6101da6107ef565b6040516101e79190610a12565b60405180910390f35b6101f86107f7565b6040516102059190610a12565b60405180910390f35b61022860048036038101906102239190610d1d565b6107fd565b6040516102359190610ca4565b60405180910390f35b61024661081d565b6040516102539190610a12565b60405180910390f35b610264610823565b6040516102719190610c67565b60405180910390f35b6102826108b5565b60405161028f9190610de6565b60405180910390f35b6102a06108eb565b6040516102ad9190610c67565b60405180910390f35b600860009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166366e305fd336040518263ffffffff1660e01b81526004016103119190610e10565b602060405180830381865afa15801561032e573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103529190610e57565b610391576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161038890610ed0565b60405180910390fd5b600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161561041e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161041590610f3c565b60405180910390fd5b600354421015610463576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161045a90610fa8565b60405180910390fd5b6004544211156104a8576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161049f90611014565b60405180910390fd5b806000111580156104bd575060008054905081105b6104fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104f390611080565b60405180910390fd5b600081815481106105105761050f6110a0565b5b90600052602060002090600202016001016000815480929190610532906110fe565b91905055506001600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055503373ffffffffffffffffffffffffffffffffffffffff167fb87a61d78bd15221c59b983f6ef032fbde0631e66bfe18d1421fe5a73c16741d60405160405180910390a250565b60035481565b60055481565b600081815481106105f157600080fd5b906000526020600020906002020160009150905080600001805461061490611175565b80601f016020809104026020016040519081016040528092919081815260200182805461064090611175565b801561068d5780601f106106625761010080835404028352916020019161068d565b820191906000526020600020905b81548152906001019060200180831161067057829003601f168201915b5050505050908060010154905082565b60606000805480602002602001604051908101604052809291908181526020016000905b8282101561078f57838290600052602060002090600202016040518060400160405290816000820180546106f490611175565b80601f016020809104026020016040519081016040528092919081815260200182805461072090611175565b801561076d5780601f106107425761010080835404028352916020019161076d565b820191906000526020600020905b81548152906001019060200180831161075057829003601f168201915b50505050508152602001600182015481525050815260200190600101906106c1565b50505050905090565b60606040518060400160405280600b81526020017f48656c6c6f20576f726c64000000000000000000000000000000000000000000815250905090565b600060035442101580156107ea575060045442105b905090565b600042905090565b60045481565b60026020528060005260406000206000915054906101000a900460ff1681565b60065481565b60606007805461083290611175565b80601f016020809104026020016040519081016040528092919081815260200182805461085e90611175565b80156108ab5780601f10610880576101008083540402835291602001916108ab565b820191906000526020600020905b81548152906001019060200180831161088e57829003601f168201915b5050505050905090565b6108bd610979565b6040518060800160405280600554815260200160035481526020016004548152602001600654815250905090565b600780546108f890611175565b80601f016020809104026020016040519081016040528092919081815260200182805461092490611175565b80156109715780601f1061094657610100808354040283529160200191610971565b820191906000526020600020905b81548152906001019060200180831161095457829003601f168201915b505050505081565b6040518060800160405280600490602082028036833780820191505090505090565b600080fd5b6000819050919050565b6109b3816109a0565b81146109be57600080fd5b50565b6000813590506109d0816109aa565b92915050565b6000602082840312156109ec576109eb61099b565b5b60006109fa848285016109c1565b91505092915050565b610a0c816109a0565b82525050565b6000602082019050610a276000830184610a03565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610a67578082015181840152602081019050610a4c565b60008484015250505050565b6000601f19601f8301169050919050565b6000610a8f82610a2d565b610a998185610a38565b9350610aa9818560208601610a49565b610ab281610a73565b840191505092915050565b60006040820190508181036000830152610ad78185610a84565b9050610ae66020830184610a03565b9392505050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600082825260208201905092915050565b6000610b3582610a2d565b610b3f8185610b19565b9350610b4f818560208601610a49565b610b5881610a73565b840191505092915050565b610b6c816109a0565b82525050565b60006040830160008301518482036000860152610b8f8282610b2a565b9150506020830151610ba46020860182610b63565b508091505092915050565b6000610bbb8383610b72565b905092915050565b6000602082019050919050565b6000610bdb82610aed565b610be58185610af8565b935083602082028501610bf785610b09565b8060005b85811015610c335784840389528151610c148582610baf565b9450610c1f83610bc3565b925060208a01995050600181019050610bfb565b50829750879550505050505092915050565b60006020820190508181036000830152610c5f8184610bd0565b905092915050565b60006020820190508181036000830152610c818184610a84565b905092915050565b60008115159050919050565b610c9e81610c89565b82525050565b6000602082019050610cb96000830184610c95565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610cea82610cbf565b9050919050565b610cfa81610cdf565b8114610d0557600080fd5b50565b600081359050610d1781610cf1565b92915050565b600060208284031215610d3357610d3261099b565b5b6000610d4184828501610d08565b91505092915050565b600060049050919050565b600081905092915050565b6000819050919050565b6000610d768383610b63565b60208301905092915050565b6000602082019050919050565b610d9881610d4a565b610da28184610d55565b9250610dad82610d60565b8060005b83811015610dde578151610dc58782610d6a565b9650610dd083610d82565b925050600181019050610db1565b505050505050565b6000608082019050610dfb6000830184610d8f565b92915050565b610e0a81610cdf565b82525050565b6000602082019050610e256000830184610e01565b92915050565b610e3481610c89565b8114610e3f57600080fd5b50565b600081519050610e5181610e2b565b92915050565b600060208284031215610e6d57610e6c61099b565b5b6000610e7b84828501610e42565b91505092915050565b7f55736572206e6f74207265676973746572656400000000000000000000000000600082015250565b6000610eba601383610a38565b9150610ec582610e84565b602082019050919050565b60006020820190508181036000830152610ee981610ead565b9050919050565b7f596f75206861766520616c726561647920766f7465642e000000000000000000600082015250565b6000610f26601783610a38565b9150610f3182610ef0565b602082019050919050565b60006020820190508181036000830152610f5581610f19565b9050919050565b7f566f74696e6720686173206e6f742073746172746564207965742e0000000000600082015250565b6000610f92601b83610a38565b9150610f9d82610f5c565b602082019050919050565b60006020820190508181036000830152610fc181610f85565b9050919050565b7f566f74696e672068617320656e6465642e000000000000000000000000000000600082015250565b6000610ffe601183610a38565b915061100982610fc8565b602082019050919050565b6000602082019050818103600083015261102d81610ff1565b9050919050565b7f496e76616c69642063616e64696461746520696e6465782e0000000000000000600082015250565b600061106a601883610a38565b915061107582611034565b602082019050919050565b600060208201905081810360008301526110998161105d565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000611109826109a0565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361113b5761113a6110cf565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061118d57607f821691505b6020821081036111a05761119f611146565b5b5091905056fea264697066735822122067dd42f7e257463a02545a52b974ca85b017acdeb3a077988d7cf91e7a5857ca64736f6c63430008110033'


await connectWallet()

async function connectWallet() {
  if (window.ethereum == null) {
    console.log('MetaMask not installed; using read-only defaults')
    provider = ethers.getDefaultProvider()
  } else {
    provider = new ethers.BrowserProvider(window.ethereum)
    signer = await provider.getSigner()
    // let network = await provider.getNetwork()
    // signerAddress = await signer.getAddress()
    await provider.send('eth_requestAccounts', [])
  }
}

async function deployContract() {
  let factory = new ethers.ContractFactory(abi, bytecode, signer)

  let startList = start.value.split("/")
  let endList = end.value.split("/")
  let countList = count.value.split("/")

  // convert to unix time
  let unixTimeStart = new Date(startList[0], startList[1] - 1, startList[2], startList[3], startList[4], startList[5]).getTime() / 1000
  let unixTimeEnd = new Date(endList[0], endList[1] - 1, endList[2], endList[3], endList[4], endList[5]).getTime() / 1000
  let unixTimeCount = new Date(countList[0], countList[1] - 1, countList[2], countList[3], countList[4], countList[5]).getTime() / 1000

  // Deploy an instance of the contract
  let contract = await factory.deploy(candidates.value.split(","), unixTimeStart, unixTimeEnd, unixTimeCount, name.value, registerContractAddress)
  axios.post('http://hc5.isl.lab.nycu.edu.tw:8000/election/', {
    name: name.value,
    description: description.value,
    contract_id: contract.target
  }).then((res) => {
    alert("Contract deployed at " + contract.target)
    name.value = ''
    start.value = ''
    end.value = ''
    count.value = ''
    candidates.value = ''
    description.value = ''
  }).catch((err) => {
    console.log(err)
  })
}
</script>